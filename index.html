<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Absensi Divisi Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --gold:   #d4a017;
      --gold2:  #f5c842;
      --dark:   #5c3d00;
      --darker: #3b2600;
      --cream:  #fdf8e8;
      --amber:  #e8952a;
      --shadow: rgba(180,120,0,0.18);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 12px 40px;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 50% -10%, rgba(212,160,23,0.13) 0%, transparent 70%),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(232,149,42,0.08) 0%, transparent 60%);
      pointer-events: none; z-index: 0;
    }

    .card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 8px 40px var(--shadow);
      width: 100%;
      max-width: 420px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .card-top {
      background: linear-gradient(145deg, var(--darker) 0%, var(--dark) 60%, #8b5e00 100%);
      padding: 28px 24px 22px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .card-top::after {
      content: '';
      position: absolute;
      bottom: -1px; left: 0; right: 0;
      height: 22px;
      background: white;
      border-radius: 22px 22px 0 0;
    }

    .logo-ring {
      width: 64px; height: 64px;
      border-radius: 50%;
      border: 3px solid rgba(245,200,66,0.6);
      display: flex; align-items: center; justify-content: center;
      font-size: 30px;
      margin: 0 auto 12px;
      background: rgba(245,200,66,0.1);
      box-shadow: 0 0 0 6px rgba(245,200,66,0.08);
    }
    h1 {
      font-family: 'Cinzel', serif;
      color: var(--gold2);
      font-size: 19px;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.4);
      margin-bottom: 4px;
    }
    .sub-title { color: rgba(255,230,150,0.75); font-size: 12px; letter-spacing: 1px; }

    .card-body { padding: 24px 22px 26px; }

    .field-label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: #9a7a30;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }

    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1.5px solid #e8d99a;
      font-size: 14px;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      outline: none;
      background: #fffdf2 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23b8860b' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 14px center;
      appearance: none; -webkit-appearance: none;
      color: var(--darker);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212,160,23,0.15); }

    .section-gap { margin-top: 18px; }

    .status-container { display: flex; gap: 10px; }
    .status-opt {
      flex: 1; padding: 12px 8px;
      border: 2px solid #e8d99a;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      font-weight: 700; font-size: 13px;
      color: #b8860b;
      transition: all 0.2s;
      background: #fffdf2;
      user-select: none;
    }
    .status-opt:active { transform: scale(0.97); }
    .status-opt.active {
      background: linear-gradient(135deg, var(--darker), var(--dark), #a06800);
      color: #ffd700;
      border-color: var(--dark);
      box-shadow: 0 4px 14px rgba(92,61,0,0.3);
    }

    .tugas-box {
      margin-top: 14px;
      background: #fffbe8;
      padding: 13px 15px;
      border-radius: 12px;
      border: 1.5px solid #e8d99a;
      display: flex; align-items: center; gap: 12px;
    }
    .tugas-box input[type="checkbox"] {
      width: 22px; height: 22px;
      cursor: pointer; accent-color: var(--dark); flex-shrink: 0;
    }
    .tugas-label { cursor: pointer; font-weight: 700; color: var(--dark); font-size: 13.5px; }
    .tugas-label small { display: block; font-weight: 400; color: #b09050; font-size: 11.5px; margin-top: 2px; }

    #previewContainer {
      width: 100%; height: 220px;
      border: 2px dashed #d4a017;
      border-radius: 16px; margin-top: 16px;
      display: flex; align-items: center; justify-content: center;
      background: #fffdf2; cursor: pointer;
      overflow: hidden; position: relative;
      transition: background 0.2s;
    }
    #previewContainer:active { background: #fff8e0; }
    #imgPreview { width: 100%; height: 100%; object-fit: cover; display: none; }
    #placeholderText { text-align: center; color: #c9a030; pointer-events: none; }
    #placeholderText .cam-icon { font-size: 44px; line-height: 1; }
    #placeholderText b { display: block; margin-top: 8px; font-size: 14px; letter-spacing: 0.5px; }
    #placeholderText small { font-size: 12px; color: #d4b060; margin-top: 4px; display: block; }

    #gpsStatus { font-size: 12px; text-align: center; margin-top: 10px; min-height: 18px; color: #9a8050; }
    #gpsStatus.ok  { color: #2e7d32; }
    #gpsStatus.err { color: #c62828; }

    .btn-submit {
      width: 100%; padding: 15px; margin-top: 18px;
      border-radius: 14px; border: none;
      font-size: 15px; font-weight: 800;
      font-family: 'Nunito', sans-serif;
      letter-spacing: 1px; cursor: pointer;
      background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, var(--amber) 100%);
      color: #ffd700;
      box-shadow: 0 5px 20px rgba(92,61,0,0.35);
      transition: all 0.2s; position: relative; overflow: hidden;
    }
    .btn-submit::after {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    }
    .btn-submit:active { transform: scale(0.98); box-shadow: 0 2px 10px rgba(92,61,0,0.25); }
    .btn-submit:disabled { background: #ccc; color: #999; box-shadow: none; cursor: not-allowed; }

    #msg { text-align: center; margin-top: 10px; font-weight: 700; font-size: 13px; color: var(--dark); min-height: 18px; }
  </style>
</head>
<body>

<div class="card">
  <div class="card-top">
    <div class="logo-ring">üìã</div>
    <h1>ABSENSI ADMIN</h1>
    <div class="sub-title">Divisi Administrasi</div>
  </div>

  <div class="card-body">

    <label class="field-label">üë§ Nama Staff</label>
    <select id="namaStaff">
      <option value="">‚Äî Pilih Nama Anda ‚Äî</option>
    </select>

    <div class="section-gap">
      <label class="field-label">üìå Status Kehadiran</label>
      <div class="status-container">
        <div class="status-opt active" id="optHadir"  onclick="pilihStatus('HADIR')">‚úÖ HADIR</div>
        <div class="status-opt"        id="optPulang" onclick="pilihStatus('PULANG')">üè† PULANG</div>
      </div>
    </div>

    <div class="tugas-box">
      <input type="checkbox" id="isTugasKeluar">
      <label for="isTugasKeluar" class="tugas-label">
        üöó TUGAS KELUAR
        <small>Lokasi GPS dicatat sebagai alamat keluar</small>
      </label>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment"
           style="display:none;" onchange="handleFile(this)">

    <div id="previewContainer" onclick="document.getElementById('cameraInput').click()">
      <div id="placeholderText">
        <div class="cam-icon">üì∑</div>
        <b>KETUK UNTUK FOTO</b>
        <small>Wajah &amp; Background Lokasi</small>
      </div>
      <img id="imgPreview" alt="preview foto absen">
    </div>

    <div id="gpsStatus">üì° Menunggu GPS...</div>

    <button class="btn-submit" id="btnKirim" onclick="submitAbsensi()">
      üì® KIRIM ABSENSI
    </button>
    <div id="msg"></div>

  </div>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ GANTI DENGAN URL DEPLOY APPS SCRIPT ANDA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwhyrMvPa4Lfp9hSMAgjhNrsqhYTiZSSpfavNDhKVMtITTSbBwxvsR_sN-bVD_yVqFp8w/exec";

  var base64Foto   = null;
  var statusAbsen  = "HADIR";
  var koordinatGPS = null;
  var gpsLoading   = false;

  const elNama   = document.getElementById('namaStaff');
  const elGPS    = document.getElementById('gpsStatus');
  const elBtn    = document.getElementById('btnKirim');
  const elMsg    = document.getElementById('msg');

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.onload = function () {
    loadStaff();
    ambilGPS();
  };

  function loadStaff() {
    fetch(GAS_URL + "?action=getStaffList")
      .then(r => r.json())
      .then(names => {
        names.forEach(n => {
          if (!n) return;
          const o = document.createElement('option');
          o.value = n; o.textContent = n;
          elNama.appendChild(o);
        });
      })
      .catch(() => {
        elMsg.innerHTML = '<span style="color:#c62828">‚ö†Ô∏è Gagal memuat daftar staff. Cek koneksi.</span>';
      });
  }

  // ‚îÄ‚îÄ Status HADIR / PULANG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function pilihStatus(s) {
    statusAbsen = s;
    document.getElementById('optHadir').classList.toggle('active',  s === 'HADIR');
    document.getElementById('optPulang').classList.toggle('active', s === 'PULANG');
  }

  // ‚îÄ‚îÄ Foto + Watermark ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function handleFile(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ratio  = Math.min(1, 800 / img.width);
        canvas.width  = Math.round(img.width  * ratio);
        canvas.height = Math.round(img.height * ratio);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const nama  = elNama.value || "-";
        const tugas = document.getElementById('isTugasKeluar').checked;
        const now   = new Date();
        const jam   = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        const tgl   = now.toLocaleDateString('id-ID', { day:'2-digit', month:'long', year:'numeric' });

        const baris = [
          "DIVISI ADMIN",
          statusAbsen + "  ‚Äî  " + (tugas ? "TUGAS KELUAR" : "KANTOR"),
          nama,
          tgl + "  " + jam
        ];

        const fs  = Math.max(14, Math.round(canvas.width / 26));
        const pad = Math.round(fs * 0.65);
        const lh  = fs + pad;
        const bxH = lh * baris.length + pad * 2;
        const bxY = canvas.height - bxH;

        ctx.fillStyle = 'rgba(0,0,0,0.62)';
        ctx.fillRect(0, bxY, canvas.width, bxH);
        ctx.fillStyle = '#d4a017';
        ctx.fillRect(0, bxY, canvas.width, Math.max(3, Math.round(fs * 0.22)));

        ctx.textAlign = 'left'; ctx.textBaseline = 'top';
        baris.forEach((teks, i) => {
          const y = bxY + pad + lh * i;
          if (i === 0) {
            ctx.font = 'bold ' + Math.round(fs * 1.05) + 'px sans-serif';
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillText(teks, pad+1, y+1);
            ctx.fillStyle = '#FFD700'; ctx.fillText(teks, pad, y);
          } else {
            ctx.font = (i === 2 ? 'bold ' : '') + fs + 'px sans-serif';
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillText(teks, pad+1, y+1);
            ctx.fillStyle = 'white'; ctx.fillText(teks, pad, y);
          }
        });

        base64Foto = canvas.toDataURL('image/jpeg', 0.82);
        const prev = document.getElementById('imgPreview');
        prev.src = base64Foto; prev.style.display = 'block';
        document.getElementById('placeholderText').style.display = 'none';
        input.value = '';
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }

  // ‚îÄ‚îÄ GPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function ambilGPS() {
    if (!navigator.geolocation) {
      elGPS.textContent = '‚ùå Browser tidak mendukung GPS'; return;
    }
    gpsLoading = true;
    elGPS.textContent = 'üì° Mengunci GPS...';
    elGPS.className = '';

    navigator.geolocation.getCurrentPosition(
      pos => { simpanKoordinat(pos); setTimeout(ambilGPS, 30000); },
      () => {
        navigator.geolocation.getCurrentPosition(
          pos => { simpanKoordinat(pos); setTimeout(ambilGPS, 30000); },
          () => {
            gpsLoading = false; koordinatGPS = null;
            elGPS.innerHTML = '‚ö†Ô∏è GPS gagal. <a href="#" onclick="ambilGPS();return false;">Coba lagi</a>';
            elGPS.className = 'err';
            setTimeout(ambilGPS, 15000);
          },
          { enableHighAccuracy: false, timeout: 20000, maximumAge: 30000 }
        );
      },
      { enableHighAccuracy: true, timeout: 25000, maximumAge: 30000 }
    );
  }

  function simpanKoordinat(pos) {
    koordinatGPS = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    gpsLoading   = false;
    elGPS.textContent = '‚úÖ GPS terkunci (¬±' + Math.round(pos.coords.accuracy) + 'm)';
    elGPS.className   = 'ok';
  }

  // ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function submitAbsensi() {
    const nama  = elNama.value;
    const tugas = document.getElementById('isTugasKeluar').checked;

    if (!nama)       return Swal.fire("Nama Kosong",  "Silakan pilih nama Anda!", "warning");
    if (!base64Foto) return Swal.fire("Foto Kosong",  "Ambil foto terlebih dahulu!", "warning");
    if (gpsLoading)  return Swal.fire("Harap Tunggu", "GPS sedang mengunci lokasi...", "info");

    if (!koordinatGPS) {
      elBtn.disabled = true;
      elMsg.innerHTML = '‚è≥ Mencoba GPS...';
      navigator.geolocation.getCurrentPosition(
        pos => { simpanKoordinat(pos); kirim(pos.coords.latitude, pos.coords.longitude, tugas); },
        () => {
          navigator.geolocation.getCurrentPosition(
            pos => { simpanKoordinat(pos); kirim(pos.coords.latitude, pos.coords.longitude, tugas); },
            () => {
              elBtn.disabled = false; elMsg.innerHTML = '';
              Swal.fire("GPS Gagal",
                "Gagal mendapatkan lokasi.<br><br>" +
                "Tips:<br>‚Ä¢ Aktifkan GPS/Lokasi HP<br>‚Ä¢ Izinkan akses lokasi di browser<br>‚Ä¢ Coba dekat jendela", "error");
            },
            { enableHighAccuracy: false, timeout: 20000, maximumAge: 60000 }
          );
        },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 60000 }
      );
      return;
    }
    kirim(koordinatGPS.lat, koordinatGPS.lon, tugas);
  }

  function kirim(lat, lon, tugasKeluar) {
    elBtn.disabled = true;
    elMsg.innerHTML = '‚è≥ Mengirim absensi...';

    fetch(GAS_URL, {
      method : 'POST',
      headers: { 'Content-Type': 'text/plain' }, // text/plain agar tidak trigger CORS preflight
      body   : JSON.stringify({
        action       : 'prosesAbsenAdmin',
        lat          : lat,
        lon          : lon,
        namaStaff    : elNama.value,
        imageBase64  : base64Foto,
        status       : statusAbsen,
        isTugasKeluar: tugasKeluar
      })
    })
    .then(r => r.json())
    .then(res => {
      elBtn.disabled = false;
      elMsg.innerHTML = '';
      if (typeof res === 'object' && res.status === "BERHASIL") {
        Swal.fire({
          icon : 'success',
          title: 'Berhasil! ‚≠ê',
          html : '<b>' + res.nama + '</b><br>' + res.pesan +
                 '<br><small>Jam: ' + res.jam + ' | Jarak: ' + res.jarak + '</small>',
          confirmButtonColor: '#b8860b'
        }).then(() => location.reload());
      } else {
        const err = typeof res === 'string' ? res : (res.error || JSON.stringify(res));
        Swal.fire('Gagal', err, 'error');
        elMsg.innerHTML = '<span style="color:#c62828">' + err + '</span>';
      }
    })
    .catch(err => {
      elBtn.disabled = false; elMsg.innerHTML = '';
      Swal.fire('Error Koneksi', 'Gagal terhubung ke server.<br>' + err.message, 'error');
    });
  }
</script>
</body>
</html>
